<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"><meta name="apple-mobile-web-app-capable" content="yes"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><style>@media screen{body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button{-webkit-tap-highlight-color:transparent;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:0;color:inherit;cursor:pointer;font-size:inherit;opacity:.8;outline:none;padding:0;transition:opacity .2s linear}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:disabled,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:disabled,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:disabled,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button:disabled{cursor:not-allowed;opacity:.15!important}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:hover,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:hover,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:hover,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button:hover{opacity:1}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:active,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:active,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:hover:active,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button:hover:active{opacity:.6}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:not(:disabled),body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:not(:disabled),body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:hover:not(:disabled),body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button:hover:not(:disabled){transition:none}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev],body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button.bespoke-marp-presenter-info-page-prev{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI1IiBkPSJNNjggOTAgMjggNTBsNDAtNDAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button.bespoke-marp-presenter-info-page-next{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI1IiBkPSJtMzIgOTAgNDAtNDAtNDAtNDAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen]{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48c3R5bGU+LmF7ZmlsbDpub25lO3N0cm9rZTojZmZmO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2Utd2lkdGg6NXB4fTwvc3R5bGU+PC9kZWZzPjxyZWN0IGNsYXNzPSJhIiB4PSIxMCIgeT0iMjAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI2MCIgcng9IjUuNjciLz48cGF0aCBjbGFzcz0iYSIgZD0iTTQwIDcwSDIwVjUwbTIwIDBMMjAgNzBtNDAtNDBoMjB2MjBtLTIwIDAgMjAtMjAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button.exit[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button.exit[data-bespoke-marp-osc=fullscreen]{background-image:url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48c3R5bGU+LmF7ZmlsbDpub25lO3N0cm9rZTojZmZmO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2Utd2lkdGg6NXB4fTwvc3R5bGU+PC9kZWZzPjxyZWN0IGNsYXNzPSJhIiB4PSIxMCIgeT0iMjAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI2MCIgcng9IjUuNjciLz48cGF0aCBjbGFzcz0iYSIgZD0iTTIwIDUwaDIwdjIwbS0yMCAwIDIwLTIwbTQwIDBINjBWMzBtMjAgMEw2MCA1MCIvPjwvc3ZnPg==")}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter]{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNODcuOCA0Ny41Qzg5IDUwIDg3LjcgNTIgODUgNTJIMzVhOC43IDguNyAwIDAgMS03LjItNC41bC0xNS42LTMxQzExIDE0IDEyLjIgMTIgMTUgMTJoNTBhOC44IDguOCAwIDAgMSA3LjIgNC41ek02MCA1MnYzNm0tMTAgMGgyME00NSA0MmgyMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS13aWR0aD0iNSIvPjwvc3ZnPg==") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button.bespoke-marp-presenter-note-bigger{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNMTIgNTBoODBNNTIgOTBWMTAiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9IjUiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button.bespoke-marp-presenter-note-smaller{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNMTIgNTBoODAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9IjUiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}}.bespoke-marp-note,.bespoke-marp-osc,.bespoke-progress-parent{display:none;transition:none}@media screen{body,html{height:100%;margin:0}body{background:#000;overflow:hidden}svg.bespoke-marp-slide{content-visibility:hidden;opacity:0;pointer-events:none;z-index:-1}svg.bespoke-marp-slide.bespoke-marp-active{content-visibility:visible;opacity:1;pointer-events:auto;z-index:0}svg.bespoke-marp-slide.bespoke-marp-active.bespoke-marp-active-ready *{-webkit-animation-name:__bespoke_marp__!important;animation-name:__bespoke_marp__!important}@supports not (content-visibility:hidden){svg.bespoke-marp-slide[data-bespoke-marp-load=hideable]{display:none}svg.bespoke-marp-slide[data-bespoke-marp-load=hideable].bespoke-marp-active{display:block}}[data-bespoke-marp-fragment=inactive]{visibility:hidden}body[data-bespoke-view=""] .bespoke-marp-parent,body[data-bespoke-view=next] .bespoke-marp-parent{bottom:0;left:0;position:absolute;right:0;top:0}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc{background:rgba(0,0,0,.65);border-radius:7px;bottom:50px;color:#fff;contain:paint;display:block;font-family:Helvetica,Arial,sans-serif;font-size:16px;left:50%;line-height:0;opacity:1;padding:12px;position:absolute;touch-action:manipulation;transform:translateX(-50%);transition:opacity .2s linear;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap;will-change:transform;z-index:1}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>*,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>*{margin-left:6px}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>:first-child,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>:first-child{margin-left:0}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>span,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>span{opacity:.8}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>span[data-bespoke-marp-osc=page],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>span[data-bespoke-marp-osc=page]{display:inline-block;min-width:140px;text-align:center}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter],body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev]{height:32px;line-height:32px;width:32px}body[data-bespoke-view=""] .bespoke-marp-parent.bespoke-marp-inactive,body[data-bespoke-view=next] .bespoke-marp-parent.bespoke-marp-inactive{cursor:none}body[data-bespoke-view=""] .bespoke-marp-parent.bespoke-marp-inactive>.bespoke-marp-osc,body[data-bespoke-view=next] .bespoke-marp-parent.bespoke-marp-inactive>.bespoke-marp-osc{opacity:0;pointer-events:none}body[data-bespoke-view=""] svg.bespoke-marp-slide,body[data-bespoke-view=next] svg.bespoke-marp-slide{height:100%;left:0;position:absolute;top:0;width:100%}body[data-bespoke-view=""] .bespoke-progress-parent{background:#222;display:flex;height:5px;width:100%}body[data-bespoke-view=""] .bespoke-progress-parent+.bespoke-marp-parent{top:5px}body[data-bespoke-view=""] .bespoke-progress-parent .bespoke-progress-bar{background:#0288d1;flex:0 0 0;transition:flex-basis .2s cubic-bezier(0,1,1,1)}body[data-bespoke-view=next]{background:transparent}body[data-bespoke-view=presenter]{background:#161616}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container{display:grid;font-family:Helvetica,Arial,sans-serif;grid-template:"current dragbar next" minmax(140px,1fr) "current dragbar note" 2fr "info    dragbar note" 3em;grid-template-columns:minmax(3px,var(--bespoke-marp-presenter-split-ratio,66%)) 0 minmax(3px,1fr);height:100%;left:0;position:absolute;top:0;width:100%}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-parent{grid-area:current;overflow:hidden;position:relative}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-parent svg.bespoke-marp-slide{height:calc(100% - 40px);left:20px;pointer-events:none;position:absolute;top:20px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:calc(100% - 40px)}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-parent svg.bespoke-marp-slide.bespoke-marp-active{filter:drop-shadow(0 3px 10px rgba(0,0,0,.5))}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-dragbar-container{background:#0288d1;cursor:col-resize;grid-area:dragbar;margin-left:-3px;opacity:0;position:relative;transition:opacity .4s linear .1s;width:6px;z-index:10}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-dragbar-container:hover{opacity:1}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-dragbar-container.active{opacity:1;transition-delay:0s}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-next-container{background:#222;cursor:pointer;display:none;grid-area:next;overflow:hidden;position:relative}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-next-container.active{display:block}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-next-container iframe.bespoke-marp-presenter-next{background:transparent;border:0;display:block;filter:drop-shadow(0 3px 10px rgba(0,0,0,.5));height:calc(100% - 40px);left:20px;pointer-events:none;position:absolute;top:20px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:calc(100% - 40px)}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container{background:#222;color:#eee;grid-area:note;position:relative;z-index:1}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button{height:1.5em;line-height:1.5em;width:1.5em}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-presenter-note-wrapper{bottom:0;display:block;left:0;position:absolute;right:0;top:0}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-presenter-note-buttons{background:rgba(0,0,0,.65);border-radius:4px;bottom:0;display:flex;gap:4px;margin:12px;opacity:0;padding:6px;pointer-events:none;position:absolute;right:0;transition:opacity .2s linear}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-presenter-note-buttons:focus-within,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-presenter-note-wrapper:focus-within+.bespoke-marp-presenter-note-buttons,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container:hover .bespoke-marp-presenter-note-buttons{opacity:1;pointer-events:auto}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note{word-wrap:break-word;box-sizing:border-box;font-size:calc(1.1em*var(--bespoke-marp-note-font-scale, 1));height:calc(100% - 40px);margin:20px;overflow:auto;padding-right:3px;scrollbar-color:hsla(0,0%,93%,.5) transparent;scrollbar-width:thin;white-space:pre-wrap;width:calc(100% - 40px)}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note::-webkit-scrollbar{width:6px}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note::-webkit-scrollbar-track{background:transparent}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note::-webkit-scrollbar-thumb{background:hsla(0,0%,93%,.5);border-radius:6px}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note:empty{pointer-events:none}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note.active{display:block}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note p:first-child{margin-top:0}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note p:last-child{margin-bottom:0}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container{align-items:center;box-sizing:border-box;color:#eee;display:flex;flex-wrap:nowrap;grid-area:info;justify-content:center;overflow:hidden;padding:0 10px}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-page,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-time,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-timer{box-sizing:border-box;display:block;padding:0 10px;white-space:nowrap;width:100%}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button{height:1.5em;line-height:1.5em;width:1.5em}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-page{order:2;text-align:center}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-page .bespoke-marp-presenter-info-page-text{display:inline-block;min-width:120px;text-align:center}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-time{color:#999;order:1;text-align:left}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-timer{color:#999;order:3;text-align:right}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-timer:hover{cursor:pointer}}@media print{.bespoke-marp-presenter-info-container,.bespoke-marp-presenter-next-container,.bespoke-marp-presenter-note-container{display:none}}</style><style>@charset "UTF-8";@import url("https://fonts.googleapis.com/css?family=Lato:400,900|Roboto+Mono:400,700&display=swap");div#p>svg>foreignObject>section{width:1280px;height:720px;box-sizing:border-box;overflow:hidden;position:relative;scroll-snap-align:center center}div#p>svg>foreignObject>section:after{bottom:0;content:attr(data-marpit-pagination);padding:inherit;pointer-events:none;position:absolute;right:0}div#p>svg>foreignObject>section:not([data-marpit-pagination]):after{display:none}/* Normalization */div#p>svg>foreignObject>section h1{font-size:2em;margin:0.67em 0}div#p>svg>foreignObject>section video::-webkit-media-controls{will-change:transform}@page{size:1280px 720px;margin:0}@media print{body,html{background-color:#fff;margin:0;page-break-inside:avoid;break-inside:avoid-page}div#p>svg>foreignObject>section{page-break-before:always;break-before:page}div#p>svg>foreignObject>section,div#p>svg>foreignObject>section *{-webkit-print-color-adjust:exact!important;animation-delay:0s!important;animation-duration:0s!important;color-adjust:exact!important;transition:none!important}div#p>svg[data-marpit-svg]{display:block;height:100vh;width:100vw}}div#p>svg>foreignObject>section svg[data-marp-fitting=svg]{display:block;height:auto;width:100%}@supports (-ms-ime-align:auto){div#p>svg>foreignObject>section svg[data-marp-fitting=svg]{position:static}}div#p>svg>foreignObject>section svg[data-marp-fitting=svg].__reflow__{content:""}@supports (-ms-ime-align:auto){div#p>svg>foreignObject>section svg[data-marp-fitting=svg].__reflow__{position:relative}}div#p>svg>foreignObject>section [data-marp-fitting-svg-content]{display:table;white-space:nowrap;width:-webkit-max-content;width:-moz-max-content;width:max-content}div#p>svg>foreignObject>section [data-marp-fitting-svg-content-wrap]{white-space:pre}div#p>svg>foreignObject>section img[data-marp-twemoji]{background:transparent;height:1em;margin:0 .05em 0 .1em;vertical-align:-.1em;width:1em}
/*!
 * Marp / Marpit Gaia theme.
 *
 * @theme gaia
 * @author Yuki Hattori
 *
 * @auto-scaling true
 * @size 16:9 1280px 720px
 * @size 4:3 960px 720px
 */div#p>svg>foreignObject>section .hljs{background:#000;color:#f8f8f8;display:block;overflow-x:auto;padding:.5em}div#p>svg>foreignObject>section .hljs-comment,div#p>svg>foreignObject>section .hljs-quote{color:#aeaeae;font-style:italic}div#p>svg>foreignObject>section .hljs-keyword,div#p>svg>foreignObject>section .hljs-selector-tag,div#p>svg>foreignObject>section .hljs-type{color:#e28964}div#p>svg>foreignObject>section .hljs-string{color:#65b042}div#p>svg>foreignObject>section .hljs-subst{color:#daefa3}div#p>svg>foreignObject>section .hljs-link,div#p>svg>foreignObject>section .hljs-regexp{color:#e9c062}div#p>svg>foreignObject>section .hljs-name,div#p>svg>foreignObject>section .hljs-section,div#p>svg>foreignObject>section .hljs-tag,div#p>svg>foreignObject>section .hljs-title{color:#89bdff}div#p>svg>foreignObject>section .hljs-class .hljs-title,div#p>svg>foreignObject>section .hljs-doctag{text-decoration:underline}div#p>svg>foreignObject>section .hljs-bullet,div#p>svg>foreignObject>section .hljs-number,div#p>svg>foreignObject>section .hljs-symbol{color:#3387cc}div#p>svg>foreignObject>section .hljs-params,div#p>svg>foreignObject>section .hljs-template-variable,div#p>svg>foreignObject>section .hljs-variable{color:#3e87e3}div#p>svg>foreignObject>section .hljs-attribute{color:#cda869}div#p>svg>foreignObject>section .hljs-meta{color:#8996a8}div#p>svg>foreignObject>section .hljs-formula{background-color:#0e2231;color:#f8f8f8;font-style:italic}div#p>svg>foreignObject>section .hljs-addition{background-color:#253b22;color:#f8f8f8}div#p>svg>foreignObject>section .hljs-deletion{background-color:#420e09;color:#f8f8f8}div#p>svg>foreignObject>section .hljs-selector-class{color:#9b703f}div#p>svg>foreignObject>section .hljs-selector-id{color:#8b98ab}div#p>svg>foreignObject>section .hljs-emphasis{font-style:italic}div#p>svg>foreignObject>section .hljs-strong{font-weight:700}div#p>svg>foreignObject>section svg[data-marp-fitting=svg]{max-height:580px}div#p>svg>foreignObject>section h1,div#p>svg>foreignObject>section h2,div#p>svg>foreignObject>section h3,div#p>svg>foreignObject>section h4,div#p>svg>foreignObject>section h5,div#p>svg>foreignObject>section h6{margin:.5em 0 0}div#p>svg>foreignObject>section h1 strong,div#p>svg>foreignObject>section h2 strong,div#p>svg>foreignObject>section h3 strong,div#p>svg>foreignObject>section h4 strong,div#p>svg>foreignObject>section h5 strong,div#p>svg>foreignObject>section h6 strong{font-weight:inherit}div#p>svg>foreignObject>section h1{font-size:1.8em}div#p>svg>foreignObject>section h2{font-size:1.5em}div#p>svg>foreignObject>section h3{font-size:1.3em}div#p>svg>foreignObject>section h4{font-size:1.1em}div#p>svg>foreignObject>section h5{font-size:1em}div#p>svg>foreignObject>section h6{font-size:.9em}div#p>svg>foreignObject>section blockquote,div#p>svg>foreignObject>section p{margin:1em 0 0}div#p>svg>foreignObject>section ol>li,div#p>svg>foreignObject>section ul>li{margin:.3em 0 0}div#p>svg>foreignObject>section ol>li>p,div#p>svg>foreignObject>section ul>li>p{margin:.6em 0 0}div#p>svg>foreignObject>section code{display:inline-block;font-family:Roboto Mono,monospace;font-size:.8em;letter-spacing:0;margin:-.1em .15em;padding:.1em .2em;vertical-align:baseline}div#p>svg>foreignObject>section pre{display:block;margin:1em 0 0;min-height:1em;overflow:visible}div#p>svg>foreignObject>section pre code{box-sizing:border-box;font-size:.7em;margin:0;min-width:100%;padding:.5em}div#p>svg>foreignObject>section pre code svg[data-marp-fitting=svg]{max-height:calc(580px - 1em)}div#p>svg>foreignObject>section blockquote{margin:1em 0 0;padding:0 1em;position:relative}div#p>svg>foreignObject>section blockquote:after,div#p>svg>foreignObject>section blockquote:before{content:"“";display:block;font-family:Times New Roman,serif;font-weight:700;position:absolute}div#p>svg>foreignObject>section blockquote:before{left:0;top:0}div#p>svg>foreignObject>section blockquote:after{bottom:0;right:0;transform:rotate(180deg)}div#p>svg>foreignObject>section blockquote>:first-child{margin-top:0}div#p>svg>foreignObject>section mark{background:transparent}div#p>svg>foreignObject>section table{border-collapse:collapse;border-spacing:0;margin:1em 0 0}div#p>svg>foreignObject>section table td,div#p>svg>foreignObject>section table th{border-style:solid;border-width:1px;padding:.2em .4em}div#p>svg>foreignObject>section footer,div#p>svg>foreignObject>section header,div#p>svg>foreignObject>section:after{box-sizing:border-box;font-size:66%;height:70px;line-height:50px;overflow:hidden;padding:10px 25px;position:absolute}div#p>svg>foreignObject>section:after{--marpit-root-font-size:66%}div#p>svg>foreignObject>section header{top:0}div#p>svg>foreignObject>section footer,div#p>svg>foreignObject>section header{left:0;right:0}div#p>svg>foreignObject>section footer{bottom:0}div#p>svg>foreignObject>section{word-wrap:break-word;--color-background:#fff8e1;--color-background-stripe:rgba(69,90,100,.1);--color-foreground:#455a64;--color-dimmed:#6a7a7d;--color-highlight:#0288d1;background-color:var(--color-background);background-image:linear-gradient(135deg,hsla(0,0%,53%,0),hsla(0,0%,53%,.02) 50%,hsla(0,0%,100%,0) 0,hsla(0,0%,100%,.05));color:var(--color-foreground);font-family:Lato,Avenir Next,Avenir,Trebuchet MS,Segoe UI,sans-serif;font-size:35px;height:720px;letter-spacing:1.25px;line-height:1.35;padding:70px;width:1280px}div#p>svg>foreignObject>section{--marpit-root-font-size:35px}div#p>svg>foreignObject>section:after{bottom:0;font-size:80%;right:0}div#p>svg>foreignObject>section:after{--marpit-root-font-size:80%}div#p>svg>foreignObject>section a,div#p>svg>foreignObject>section mark{color:var(--color-highlight)}div#p>svg>foreignObject>section code{background:var(--color-dimmed);color:var(--color-background)}div#p>svg>foreignObject>section h1 strong,div#p>svg>foreignObject>section h2 strong,div#p>svg>foreignObject>section h3 strong,div#p>svg>foreignObject>section h4 strong,div#p>svg>foreignObject>section h5 strong,div#p>svg>foreignObject>section h6 strong{color:var(--color-highlight)}div#p>svg>foreignObject>section pre>code{background:var(--color-foreground)}div#p>svg>foreignObject>section blockquote:after,div#p>svg>foreignObject>section blockquote:before,div#p>svg>foreignObject>section footer,div#p>svg>foreignObject>section header,div#p>svg>foreignObject>section section:after{color:var(--color-dimmed)}div#p>svg>foreignObject>section table td,div#p>svg>foreignObject>section table th{border-color:var(--color-foreground)}div#p>svg>foreignObject>section table thead th{background:var(--color-foreground);color:var(--color-background)}div#p>svg>foreignObject>section table tbody>tr:nth-child(odd) td,div#p>svg>foreignObject>section table tbody>tr:nth-child(odd) th{background:var(--color-background-stripe,transparent)}div#p>svg>foreignObject>section>:first-child,div#p>svg>foreignObject>section>header:first-child+*{margin-top:0}div#p>svg>foreignObject>section.invert{--color-background:#455a64;--color-background-stripe:rgba(255,248,225,.1);--color-foreground:#fff8e1;--color-dimmed:#dad8c8;--color-highlight:#81d4fa}div#p>svg>foreignObject>section.gaia{--color-background:#0288d1;--color-background-stripe:rgba(255,248,225,.1);--color-foreground:#fff8e1;--color-dimmed:#cce2de;--color-highlight:#81d4fa}div#p>svg>foreignObject>section.lead{display:flex;flex-flow:column nowrap;justify-content:center}div#p>svg>foreignObject>section.lead h1,div#p>svg>foreignObject>section.lead h2,div#p>svg>foreignObject>section.lead h3,div#p>svg>foreignObject>section.lead h4,div#p>svg>foreignObject>section.lead h5,div#p>svg>foreignObject>section.lead h6{text-align:center}div#p>svg>foreignObject>section.lead h1 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h2 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h3 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h4 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h5 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h6 svg[data-marp-fitting=svg]{--preserve-aspect-ratio:xMidYMid meet}div#p>svg>foreignObject>section.lead p{text-align:center}div#p>svg>foreignObject>section.lead blockquote>h1,div#p>svg>foreignObject>section.lead blockquote>h2,div#p>svg>foreignObject>section.lead blockquote>h3,div#p>svg>foreignObject>section.lead blockquote>h4,div#p>svg>foreignObject>section.lead blockquote>h5,div#p>svg>foreignObject>section.lead blockquote>h6,div#p>svg>foreignObject>section.lead blockquote>p{text-align:left}div#p>svg>foreignObject>section.lead blockquote svg[data-marp-fitting=svg]:not([data-marp-fitting-math]){--preserve-aspect-ratio:xMinYMin meet}div#p>svg>foreignObject>section.lead ol>li>p,div#p>svg>foreignObject>section.lead ul>li>p{text-align:left}div#p>svg>foreignObject>section.lead table{margin-left:auto;margin-right:auto}div#p>svg>foreignObject>section[data-marpit-scope-scRNTLgg]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-scRNTLgg]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-BXUUeU5j]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-BXUUeU5j]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-Fn3okqfI]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-Fn3okqfI]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-bLEgnmo7]{font-size:28px}div#p>svg>foreignObject>section[data-marpit-scope-bLEgnmo7]{--marpit-root-font-size:28px}div#p>svg>foreignObject>section[data-marpit-scope-vhZeioIa]{font-size:28px}div#p>svg>foreignObject>section[data-marpit-scope-vhZeioIa]{--marpit-root-font-size:28px}div#p>svg>foreignObject>section[data-marpit-scope-mqMQ86x6]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-mqMQ86x6]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-IQSN98o3]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-IQSN98o3]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-NXlGe1gj]{font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-NXlGe1gj]{--marpit-root-font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-qFjjv4XP]{font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-qFjjv4XP]{--marpit-root-font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-qYADLOHA]{font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-qYADLOHA]{--marpit-root-font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-v7VX83S7]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-v7VX83S7]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-qfXnd3xs]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-qfXnd3xs]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-W2kbzwov]{font-size:28px}div#p>svg>foreignObject>section[data-marpit-scope-W2kbzwov]{--marpit-root-font-size:28px}div#p>svg>foreignObject>section[data-marpit-scope-WK4wKyO1]{font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-WK4wKyO1]{--marpit-root-font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-LerTj11b]{font-size:25px}div#p>svg>foreignObject>section[data-marpit-scope-LerTj11b]{--marpit-root-font-size:25px}div#p>svg>foreignObject>section[data-marpit-scope-K7puUzyo]{font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-K7puUzyo]{--marpit-root-font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-IcbP0yxQ]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-IcbP0yxQ]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-QiqOjxzj]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-QiqOjxzj]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-bqu8yVcL]{font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-bqu8yVcL]{--marpit-root-font-size:30px}div#p>svg>foreignObject>section[data-marpit-scope-20huI9fi]{font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-20huI9fi]{--marpit-root-font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-DO2NWrvS]{font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-DO2NWrvS]{--marpit-root-font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-eLOE79tm]{font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-eLOE79tm]{--marpit-root-font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-vOYyrRqY]{font-size:27px}div#p>svg>foreignObject>section[data-marpit-scope-vOYyrRqY]{--marpit-root-font-size:27px}div#p>svg>foreignObject>section[data-marpit-scope-i5IpH8aF]{font-size:32px}div#p>svg>foreignObject>section[data-marpit-scope-i5IpH8aF]{--marpit-root-font-size:32px}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]{columns:initial!important;display:block!important;padding:0!important}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]:after,div#p>svg>foreignObject>section[data-marpit-advanced-background=background]:before,div#p>svg>foreignObject>section[data-marpit-advanced-background=content]:after,div#p>svg>foreignObject>section[data-marpit-advanced-background=content]:before{display:none!important}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container]{all:initial;display:flex;flex-direction:row;height:100%;overflow:hidden;width:100%}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container][data-marpit-advanced-background-direction=vertical]{flex-direction:column}div#p>svg>foreignObject>section[data-marpit-advanced-background=background][data-marpit-advanced-background-split]>div[data-marpit-advanced-background-container]{width:var(--marpit-advanced-background-split,50%)}div#p>svg>foreignObject>section[data-marpit-advanced-background=background][data-marpit-advanced-background-split=right]>div[data-marpit-advanced-background-container]{margin-left:calc(100% - var(--marpit-advanced-background-split, 50%))}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container]>figure{all:initial;background-position:center;background-repeat:no-repeat;background-size:cover;flex:auto;margin:0}div#p>svg>foreignObject>section[data-marpit-advanced-background=content],div#p>svg>foreignObject>section[data-marpit-advanced-background=pseudo]{background:transparent!important}div#p>svg>foreignObject>section[data-marpit-advanced-background=pseudo],div#p>svg[data-marpit-svg]>foreignObject[data-marpit-advanced-background=pseudo]{pointer-events:none!important}div#p>svg>foreignObject>section[data-marpit-advanced-background-split]{width:100%;height:100%}</style></head><body><div class="bespoke-marp-osc"><button data-bespoke-marp-osc="prev" tabindex="-1" title="Previous slide">Previous slide</button><span data-bespoke-marp-osc="page"></span><button data-bespoke-marp-osc="next" tabindex="-1" title="Next slide">Next slide</button><button data-bespoke-marp-osc="fullscreen" tabindex="-1" title="Toggle fullscreen (f)">Toggle fullscreen</button><button data-bespoke-marp-osc="presenter" tabindex="-1" title="Open presenter view (p)">Open presenter view</button></div><div id="p"><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="1" data-background-color="white" data-class="lead" data-theme="gaia" class="lead" style="--background-color:white;--class:lead;--theme:gaia;background-color:white;background-image:none;">
<h1>Lecture 3 Privilege based Isolation and Batch Processing</h1>
<h2>Section2  RISC-V : An OS's perspective</h2>
<br />
<br />
<p>Xiang Yong, Chen Yu, Li Guoliang, Ren Ju</p>
<br />
<br />
<p>Spring 2023</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="2" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="2" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<h3>1. Comparison for Mainstream Processors</h3>
<ol start="2">
<li>RISC-V system mode</li>
<li>RISC-V system programming: user mode programming</li>
<li>RISC-V system programming: M-Mode programming</li>
<li>RISC-V system programming: kernel programming</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="3" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="3" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>The main goal of this section</h4>
<ul>
<li>Understand RISC-V privilege and hardware isolation mechanisms.</li>
<li>Understand the basic characteristics of RISC-V's M-Mode and S-Mode</li>
<li>Understand how  OS <strong>accesses and controls</strong> computer systems in M-Mode and S-Mode</li>
<li>Understand how different softwares <strong>switch between M-Mode&lt;–&gt;S-Mode&lt;–&gt;U-Mode</strong></li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="4" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="4" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Comparison for Mainstream Processors</h4>

<p><img src="figs/mainstream-isas.png" alt="" style="width:1150px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="5" data-marpit-fragments="2" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="5" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Comparison for Mainstream Processors</h4>
<ul>
<li data-marpit-fragment="1">Due to compatibility and history reasons, the design and implementation of x86 and ARM are complicated</li>
<li data-marpit-fragment="2">RISC-V is concise/flexible/extensible</li>
</ul>
<p><img src="figs/x86-arm-rv-compare.png" alt="" style="width:1150px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="6" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="6" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
</ol>
<h3>2. RISC-V system mode</h3>
<ul>
<li>Overview</li>
<li>Privilege</li>
<li>CSR Registers</li>
</ul>
<ol start="3">
<li>RISC-V system programming: user mode programming</li>
<li>RISC-V system programming: M-Mode programming</li>
<li>RISC-V system programming: kernel programming</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="7" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="7" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V related terms</h4>
<ul>
<li>Application Execution Environment (AEE)</li>
<li>Application Binary Interface (ABI)</li>
<li>Supervisor Binary Interface (SBI)</li>
<li>Supervisor Execution Environment (SEE)</li>
<li>Hypervisor: virtual machine monitor</li>
<li>Hypervisor Binary interface (HBI)</li>
<li>Hypervisor Execution Environment (HEE)</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="8" data-marpit-scope-scRNTLgg="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="8" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V system mode</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>ABI/SBI/HBI:Application/Supervisor/Hypervisor Bianry Interface</li>
<li>AEE/SEE/HEE:Application/Superv/Hyperv Execution Environment</li>
<li>HAL: Hardware Abstraction Layer</li>
<li>Hypervisor, virtual machine monitor (VMM)</li>
<li>RISC-V system modes:  modes related to system programming</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="9" data-marpit-scope-BXUUeU5j="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="9" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V System Mode: Single Application Scenario</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>Different software layers have clear privilege-level hardware isolation support</li>
<li>The <strong>single app</strong> on the left is encoded to run on the ABI</li>
<li>ABI is the interface for interaction between user-level ISA (Instruction Set Architecture) and AEE</li>
<li>ABI hides the details of AEE to apps, making AEE more flexible</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="10" data-marpit-scope-Fn3okqfI="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="10" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V System Mode: OS Scenario</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>A <strong>traditional OS</strong> is added in the middle layer to support multi-tasking of multiple applications</li>
<li>Each application communicates with OS via <strong>ABI</strong></li>
<li>The RISC-V OS communicates with SEE through <strong>SBI</strong></li>
<li>SBI is the interface for the interaction between the OS kernel and SEE, and supports the ISA of OS</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="11" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="11" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V system mode: Virtual Machine Scenario</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>The virtual machine on the right can support <strong>multiple operating systems</strong></li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="12" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="12" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V System Mode: Application Scenarios</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>M Mode: small devices (e.g., bluetooth earphones)</li>
<li>U+M Mode: Embedded devices (e.g., credit card machine)</li>
<li>U+S+M Mode: mobile phone</li>
<li>U+S+H+M Mode: data center</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="13" data-marpit-scope-bLEgnmo7="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="13" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V System Mode: Hardware Threading</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>Privilege is a protection mechanism for different parts in the software stack.</li>
<li><strong>Hardware thread</strong> (hart, i.e., CPU core) is running at a specific privilege (CSR configurations)</li>
<li>When processor performs a forbidden operation in current privilege, an <strong>exception</strong> will be generated. These exceptions usually generate traps, which causes the <strong>lower-level execution environment to take over control right</strong></li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="14" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="14" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
<li>RISC-V system mode
<ul>
<li>Overview</li>
<li><strong>Privilege</strong></li>
<li>CSR registers</li>
</ul>
</li>
<li>RISC-V system programming: user mode programming</li>
<li>RISC-V system programming: M-Mode programming</li>
<li>RISC-V system programming: kernel programming</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="15" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="15" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V system mode: multiple privileges</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /><br />
-Modern processors generally have multiple privileges</p>
<ul>
<li><strong>U</strong>: User | <strong>S</strong>: Supervisor | <strong>H</strong>: Hypervisor | <strong>M</strong>: Machine</li>
</ul>
<p>Why <strong>4 modes</strong>? What are their <strong>differences and connections</strong>?</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="16" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="16" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V System Mode: Execution Environment</h4>
<table>
<thead>
<tr>
<th>Execution Environment</th>
<th>Encoding</th>
<th>Meaning</th>
<th>Across Privileges</th>
</tr>
</thead>
<tbody>
<tr>
<td>APP</td>
<td>00</td>
<td>User/Application</td>
<td><code>ecall</code></td>
</tr>
<tr>
<td>OS</td>
<td>01</td>
<td>Supervisor</td>
<td><code>ecall</code> <code>sret</code></td>
</tr>
<tr>
<td>VMM</td>
<td>10</td>
<td>Hypervisor</td>
<td>---</td>
</tr>
<tr>
<td>BIOS</td>
<td>11</td>
<td>Machine</td>
<td><code>ecall</code> <code>mret</code></td>
</tr>
</tbody>
</table>
<ul>
<li>Hardware system containing M, S, U modes is suitable for running UNIX-like OS</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="17" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="17" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V system mode: Flexible combination of privileges</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li><strong>Flexible</strong> and <strong>combinable</strong> hardware structures are required to meet the various <strong>requirements of applications</strong></li>
<li>Therefore, the above 4 modes, as well as a flexible hardware design with different combinations of 4 modes, appeared.</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="18" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="18" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V system mode: user mode</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>U-Mode (User Mode)
<ul>
<li><strong>Unprivileged</strong> mode : For fundamental computing</li>
<li>U-Mode is the CPU execution mode for <strong>application running</strong></li>
<li>Cannot execute privileged instructions and cannot directly affect the execution of other applications</li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="19" data-marpit-scope-vhZeioIa="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="19" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V system mode: supervisor mode</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>S-Mode (Supervisor Mode, Kernel Mode)
<ul>
<li>OS in the S-Mode has sufficient <strong>hardware control capability</strong></li>
<li>Privileged Mode: <strong>Limit the execution and memory access of apps</strong></li>
<li>S-Mode is the CPU execution mode when <strong>OS is running</strong></li>
<li>Can execute kernel-mode privileged instructions, can directly <strong>affect application program execution</strong></li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="20" data-marpit-scope-mqMQ86x6="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="20" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V system mode: H-Mode</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>H-Mode (Hypervisor Mode, Virtual Machine Mode)
<ul>
<li>Privileged mode: <strong>Limit the memory space accessed by the OS</strong></li>
<li>H-Mode is the CPU execution mode of <strong>Virtual Machine Monitor</strong>, which can execute the privileged instructions of H-Mode and affect OS execution directly</li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="21" data-marpit-scope-IQSN98o3="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="21" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V system mode: M-Mode</h4>
<p><img src="figs/rv-privil-arch.png" alt="" style="width:800px;" /></p>
<ul>
<li>M-Mode (Machine Mode, Physical Machine Mode)
<ul>
<li>Privileged mode: <strong>control physical memory</strong>, directly shut down</li>
<li>M-Mode is the CPU execution mode for <strong>Bootloader/BIOS running</strong></li>
<li>Can execute M-Mode privileged instructions, which can directly affect the execution of other software mentioned above</li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="22" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="22" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
<li>RISC-V system mode
<ul>
<li>Overview</li>
<li>Privilege</li>
<li><strong>CSR registers</strong></li>
</ul>
</li>
<li>RISC-V system programming: user mode programming</li>
<li>RISC-V system programming: M-Mode programming</li>
<li>RISC-V system programming: kernel programming</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="23" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="23" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Classification of RISC-V registers</h4>
<ul>
<li><strong>General purpose registers</strong> x0-x31
<ul>
<li>Accessed by general instructions</li>
<li>The fastest storage units that unprivileged instructions can get access to.</li>
</ul>
</li>
<li><strong>Control and Status Registers</strong> (CSR)
<ul>
<li>Accessed via the <strong>CSR Instructions</strong>, there can be 4096 CSRs</li>
<li>Apps running in <strong>User Mode</strong> cannot access most CSR registers</li>
<li>OS running in <strong>kernel mode</strong> controls the computer by accessing the CSR register</li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="24" data-marpit-scope-NXlGe1gj="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="24" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Isolation via CSR register</h4>
<p>OS ensures the security and reliability of the computer through hardware isolation.</p>
<ul>
<li>Set CSR to achieve isolation
<ul>
<li>Access Control: Prevent apps from accessing system-control registers
<ul>
<li><strong>ADDRESS SPACE CONFIGURATION</strong> register: mstatus/sstatus CSR</li>
</ul>
</li>
<li>Time Management: Prevent apps from occupying 100% CPU for long time
<ul>
<li><strong>interrupt configuration</strong> register: sstatus/stvec CSR</li>
</ul>
</li>
<li>Data Protection: Prevent apps from destroying or stealing data
<ul>
<li><strong>Address space related</strong> registers: sstatus/satp/stvec CSR</li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="25" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="25" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h2>Functionalities of different CSR Registers</h2>
<ul>
<li>Information Registers: extract the current system information, such as chip ID and cpu core ID</li>
<li>Trap Setting Registers: setting interrupt and exception</li>
<li>Trap Handling Registers: handling interrupt and exception</li>
<li>Memory Protection Registers: similar to the functionalities of mpu in cortex-m</li>
</ul>
<p>Interrupts and exceptions are called traps in RISC-V</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="26" data-marpit-scope-qFjjv4XP="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="26" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
<li>RISC-V system mode</li>
</ol>
<h3>3. RISC-V system programming: user mode programming</h3>
<ul>
<li>Brief introduction</li>
<li>U-Mode programming: system calls</li>
<li>Privileged operations</li>
</ul>
<ol start="4">
<li>RISC-V system programming: M-Mode programming</li>
<li>RISC-V system programming: kernel programming</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="27" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="27" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>System Programming</h4>
<ul>
<li>System programming needs to understand the <strong>privilege architecture</strong> of the processor, and be familiar with the allowed register, memory and peripheral resources of each privilege.</li>
<li><strong>Write kernel-level code</strong>, construct OS, and support app execution
<ul>
<li>Memory management, process scheduling</li>
<li>Exception handling, interrupt handling</li>
<li>System calls, Peripheral control</li>
</ul>
</li>
<li>There is usually no extensive <strong>libs</strong> and convenient <strong>debugging tools</strong></li>
<li>In this course, we mainly focus on S-Mode and U-Mode of RISC-V, and should understand some codes in M-Mode</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="28" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="28" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V U-Mode programming: Using System Calls</h4>
<ul>
<li>Apps in U-Mode cannot directly use the hardware resources</li>
<li>Environment call exception: occurs when executing <code>ecall</code>, which is equivalent to a system call</li>
<li>OS can access hardware resources directly</li>
<li>What to do if an app needs to use hardware resources?
<ul>
<li>print &quot;hello world&quot; to the screen</li>
<li>read data from file</li>
</ul>
</li>
<li>Obtain services from OS through system calls</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="29" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="29" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>U-Mode programming:  &quot;hello world&quot;</h4>
<p><a href="https://github.com/chyyuu/os_kernel_lab/tree/v4-kernel-sret-app-ecall-kernel/os/src">Workflow of printing &quot;hello world&quot; in user mode</a></p>
<p><img src="figs/print-app.png" alt="" style="width:1000px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="30" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="30" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Start execution of the first example</h4>
<p><a href="https://github.com/chyyuu/os_kernel_lab/blob/v4-kernel-sret-app-ecall-kernel/os/src/main.rs#L302">Start and execution flow of printing &quot;hello world&quot; in user mode</a></p>
<p><img src="figs/boot-print-app.png" alt="" style="width:1000px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="31" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="31" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Example 2: Execute privileged instructions in user mode</h4>
<p><a href="https://github.com/chyyuu/os_kernel_lab/blob/v4-illegal-priv-code-csr-in-u-mode-app-v2/os/src/main.rs#L306">Start and execution flow of executing privileged instructions in user mode</a></p>
<p><img src="figs/boot-priv-code-app.png" alt="" style="width:1000px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="32" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="32" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Privileged Operations</h4>
<ul>
<li>Privileged operations: privileged instructions and CSR read/write operations</li>
<li>Very few instructions:
<ul>
<li><code>mret</code> return from M-Mode, <code>sret</code> return from S-Mode, <code>wfi</code> wait for interrupt, <code>sfence.vma</code> virtual address barrier instruction for invalidating virtual memory or data synchronization</li>
</ul>
</li>
<li>Many other system management functions are implemented by reading/writing CSR<br />
Note: <code>fence.i</code> is an i-cache barrier instruction, a unprivileged instruction, which belongs to the &quot;Zifencei&quot; extended specification. It is used to maintain consistency of i-cache and d-cache.</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="33" data-marpit-scope-qYADLOHA="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="33" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
<li>RISC-V system mode</li>
<li>RISC-V system programming: user mode programming</li>
</ol>
<h3>4. RISC-V system programming: M-Mode programming</h3>
<ul>
<li>Interrupt mechanism and exception mechanism</li>
<li>Hardware response to interrupt/exception</li>
<li>Control shift for interrupt/exception handling</li>
</ul>
<ol start="5">
<li>RISC-V system programming: kernel programming</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="34" data-marpit-scope-v7VX83S7="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="34" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>M-Mode programming</h4>
<ul>
<li>M-Mode is the <strong>highest privilege mode</strong> of hart (hardware thread) in RISC-V</li>
<li>Hart can <strong>fully access to the underlying functions of the computer system</strong> under M-Mode.</li>
<li>The most important feature of M-Mode is <strong>intercept and handle interrupt/exception</strong>
<ul>
<li><strong>Synchronous exceptions</strong>: generated during instruction execution, i.e. accessing an invalid register address, or executing an instruction with an invalid opcode</li>
<li><strong>Asynchronous interrupts</strong>: Asynchronous external events or interrupts, such as timer interrupts</li>
</ul>
</li>
<li>RISC-V requires the implementation of <strong>precise exception</strong>: to ensure that all instructions before the exception are fully executed, and subsequent instructions have not started to execute</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="35" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="35" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>How hardware handles Interrupt/Exception</h4>
<ul>
<li>Hardware
<ul>
<li>Set interrupt flag</li>
<li>Call corresponding service according to Interrupt vector</li>
</ul>
</li>
<li>Software
<ul>
<li>Save context</li>
<li>Execute the interrupt service</li>
<li>Clear interrupt flag</li>
<li>Resume saved context</li>
</ul>
</li>
<li>Interrupt Vector：Interrupt--Interrupt Service，Exception--Exception Service，System call</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="36" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="36" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Overhead of Interrupt/Exception</h4>
<ol>
<li>Finding corresponding services for Interrupt/Exception/System calls</li>
<li>Creating the kernel heap &amp; stack</li>
<li>Checking the validity of syscall parameters</li>
<li>Copying kernel data to user mode.</li>
<li>Change kernel status (overhead of cache/TLB flushing)</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="37" data-marpit-scope-qfXnd3xs="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="37" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Interrupt CSR in M-Mode</h4>
<ul>
<li>mtvec(MachineTrapVector) saves the <strong>interrupt handler entry address</strong> when an interrupt/exception occurs</li>
<li>mepc(Machine Exception PC) saves the <strong>instruction PC</strong> when an interrupt/exception occurred</li>
<li>mcause(Machine Exception Cause) indicates the type of <strong>interrupt/exception</strong></li>
<li>mie(Machine Interrupt Enable) interrupt <strong>enable</strong> register</li>
<li>mip (Machine Interrupt Pending) interrupt <strong>request</strong> register</li>
<li>mtval(Machine Trap Value) saves  <strong>Additional Information</strong> of the trap</li>
<li>mscratch (Machine Scratch) temporarily stores a word-sized <strong>data</strong></li>
<li>mstatus(Machine Status) saves global interrupts and other <strong>status</strong></li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="38" data-marpit-scope-W2kbzwov="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="38" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Mstatus register</h4>
<ul>
<li>
<p>mstatus(Machine Status) saves global interrupts and other <strong>status</strong></p>
<ul>
<li>SIE controls the global interrupt in S-Mode, and MIE controls the global interrupt in M-Mode.</li>
<li>SPIE, MPIE saves old values of MIE and SIE before the interrupt occurrs.</li>
<li>SPP indicates the previous privilege is S-Mode or U-Mode (1-&gt;S-Mode, 0-&gt;U-Mode)</li>
<li>MPP indicates the previous privilege is S-Mode, U-Mode or M-Mode</li>
</ul>
<p>PP: Previous Privilege<br />
<img src="figs/mstatus.png" alt="" style="width:1000px;" /></p>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="39" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="39" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Mcause register</h4>
<p>When an exception occurs, mcause CSR will record a code indicating <strong>the event type</strong>. If the event is caused by an interrupt, the <code>Interrupt</code> bit will be set. <code>Exception Code</code> field contains the code indicating the type of the last exception.</p>
<p><img src="figs/rv-cause.png" alt="" style="width:1150px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="40" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="40" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>M-Mode Timer Interrupt</h4>
<ul>
<li>Interrupts happen asynchronously
<ul>
<li>Signals from external I/O devices</li>
</ul>
</li>
<li>Timer can generate interrupts in a stable and periodical manner
<ul>
<li>Prevent apps from occupying CPU for a long time, so that the OS Kernel can get control periodically...</li>
<li><strong>Software in higher privilege mode</strong> can control CPU</li>
<li>Software in higher privilege mode can <strong>authorize</strong> softwares in lower privilege mode to handle interrupts</li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="41" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="41" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V processor FU540 module diagram</h4>
<p><img src="figs/fu540-top-block.png" alt="" style="width:650px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="42" data-marpit-scope-WK4wKyO1="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="42" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
<li>RISC-V system mode</li>
<li>RISC-V system programming: user mode programming</li>
<li>RISC-V system programming: M-Mode programming
<ul>
<li>Interrupt mechanism and exception mechanism</li>
<li>
<h3>hardware response to interrupt/exception</h3>
</li>
<li>control shift for interrupt/exception handling</li>
</ul>
</li>
<li>RISC-V system programming: kernel programming</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="43" data-marpit-scope-LerTj11b="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="43" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>How hardware does for handling M-Mode interrupts</h4>
<ul>
<li>The PC of the <strong>exception/interrupt instruction</strong> is saved in mepc, and PC is set to mtvec.
<ul>
<li>For synchronous exceptions, mepc points to the instruction that caused the exception;</li>
<li>For asynchronous interrupts, mepc points to the location where execution should be resumed after interrupt handling.</li>
</ul>
</li>
<li>Set mcause according to <strong>interrupt/exception source</strong>, and set mtval to error address or other reserved information word.</li>
<li>Set mstatus [MIE bit] to zero to <strong>disable interrupts</strong> and <strong>save previous MIE value</strong> into MPIE
<ul>
<li>SIE controls the global interrupt of S-Mode, MIE controls the global interrupt of M-Mode;</li>
<li>SPIE records the value(before interruprt) of SIE, and MPIE records the previous value of MIE</li>
</ul>
</li>
<li><strong>Save the privilege mode before the exception occurred</strong> into MPP of mstatus, and then <strong>change the privilege mode</strong> to M. (MPP indicates that the previous privilege is S, M or U mode)</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="44" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="44" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>M-Mode interrupt handler</h4>
<pre><code><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>     let cause = cause::read();
     let stval = stval::read();

     match cause. cause() {
         Trap::Exception(Exception::UserEnvCall) =&gt; {
             cx.sepc += 4;
             cx.x[10] = do_syscall(cx.x[17], [cx.x[10], cx.x[11], cx.x[12]]) as usize;
         }
         _ =&gt; {
             panic!(
                 &quot;Unsupported trap {:?}, stval = {:#x}!&quot;,
                 cause. cause(),
                 stval
             );
         }
     }

</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="45" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="45" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Classification of M-Mode interrupts</h4>
<p>MIE of mcause register indicates the type of interrupt:</p>
<ul>
<li><strong>Software</strong> interrupt: Triggered by writing data to a memory-mapped register, one hart interrupts another hart (interprocessor interrupt)</li>
<li><strong>Timer</strong> interrupt: hart's mtime register is greater than mtimecmp register</li>
<li><strong>External</strong> interrupt: Triggered by the interrupt controller, from peripherals connected to this interrupt controller</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="46" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="46" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>RISC-V Interrupts/Exceptions</h4>
<p>Some bits of mcause register indicates the interrupt source.<br />
Column 1  represents interrupts, Column 2 represents interrupt IDs, and column 3 is the explanation of interrupts.<br />
<img src="figs/rv-interrupt.png" alt="" style="width:1000px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="47" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;--marpit-advanced-background-split:45%;" data-marpit-advanced-background="background" data-marpit-advanced-background-split="right"><div data-marpit-advanced-background-container="true" data-marpit-advanced-background-direction="horizontal"><figure style="background-image:url(&quot;figs/rv-exception.png&quot;);background-size:100%;"></figure></div></section></foreignObject><foreignObject width="55%" height="720"><section id="47" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="47" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;--marpit-advanced-background-split:45%;" data-marpit-advanced-background="content" data-marpit-advanced-background-split="right">
<h4>M-Mode RISC-V exception mechanism</h4>
<p>Some bits of mcause register indicates the exception details.<br />
Column 1(all 0) represents exceptions, column 2 represents exception IDs, and column 3 is the explanation of exceptions.<br />
</p>
</section>
</foreignObject><foreignObject width="1280" height="720" data-marpit-advanced-background="pseudo"><section style="" data-marpit-advanced-background="pseudo" data-marpit-pagination="47" data-marpit-pagination-total="72"></section></foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="48" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="48" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>How hardware does for handling M-Mode interrupts</h4>
<ul>
<li>The PC of the interrupt/exception instruction is stored in mepc, and the PC is set to mtvec.
<ul>
<li>For exceptions, mepc points to the instruction caused the exception</li>
<li>For interrupts, mepc points to where execution should be resumed after finishing handling interrupt</li>
</ul>
</li>
<li>Set mcause based on the <strong>interrupt/exception source</strong> and set mtval to the address of the error or other reserved information word.</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="49" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="49" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>How hardware does for handling M-Mode interrupts</h4>
<ul>
<li>Set mstatus[MIE bit] to zero to <strong>disable interrupts</strong> and <strong>save previous MIE value</strong> into MPIE
<ul>
<li>SIE controls the global interrupt under S-Mode, MIE controls the global interrupt under M-Mode;</li>
<li>SPIE records the value(before interruprt) of SIE, and MPIE records the previous value of MIE</li>
</ul>
</li>
<li><strong>Save the privilege mode before the exception occurred</strong> into MPP of mstatus, and then <strong>change the privilege mode</strong> to M. (MPP indicates that the previous privilege is S, M or U mode)</li>
<li>Jump to the address configured by mtvec CSR.</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="50" data-marpit-scope-K7puUzyo="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="50" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
<li>RISC-V system mode</li>
<li>RISC-V system programming: user mode programming</li>
<li>RISC-V system programming: M-Mode programming
<ul>
<li>Interrupt mechanism and exception mechanism</li>
<li>Interrupt/exception hardware response</li>
<li>
<h3>Control shift for interrupt/exception handling</h3>
</li>
</ul>
</li>
<li>RISC-V system programming: kernel programming</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="51" data-marpit-scope-IcbP0yxQ="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="51" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Handover of control for interrupt/exception handling under M-Mode</h4>
<ul>
<li>By default, all interrupts/exceptions will handover CPU control right to interrupt/exception handler in M-Mode.</li>
<li>The interrupt/exception handler in M-Mode can redirect the interrupt/exception to S-Mode, but this additional operation will slow down the processing speed of interrupts/exceptions.</li>
<li>RISC-V provides an interrupt/exception delegation mechanism, which selectively delegates interrupts/exceptions to S-Mode for handling, completely bypassing M-Mode.</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="52" data-marpit-scope-QiqOjxzj="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="52" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Handover of control for interrupt/exception handling under M-Mode</h4>
<ul>
<li><strong>mideleg/medeleg</strong> (Machine Interrupt/Exception Delegation) CSR controls which interrupts/exceptions are delegated to S-Mode for processing</li>
<li>Each bit of mideleg/medeleg corresponds to an interrupt/exception
<ul>
<li>For example, mideleg[5] corresponds to the S-Mode clock interrupt. If it is set, clock interrupt in S-Mode will be delegated to the S-Mode interrupt/exception handler rather than M-Mode interrupt/exception handler.</li>
<li>Any interrupts delegated to S-Mode can be masked by S-Mode software. sie (Supervisor Interrupt Enable) and sip (Supervisor Interrupt Pending) CSR are S-Mode control status registers</li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="53" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="53" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Interrupt delegation register mideleg</h4>
<ul>
<li>Mideleg (Machine Interrupt Delegation) controls which interrupts will be delegated to S-mode for processing</li>
<li>Each bit in mideleg corresponds to an interrupt/exception
<ul>
<li>mideleg[1] is used to control whether <strong>inter-core interrupt</strong> is delegated to S-Mode for processing</li>
<li>mideleg[5] is used to control whether to delegate <strong>timer interrupt</strong> to S-Mode for processing</li>
<li>mideleg[9] is used to control whether to delegate <strong>external interrupt</strong> to S-Mode for processing</li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="54" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="54" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Exception delegation register medeleg</h4>
<ul>
<li>Medeleg (Machine Exception Delegation) controls which exceptions are delegated to S mode for processing</li>
<li>Each in the medeleg corresponds to an interrupt/exception
<ul>
<li>medeleg[1] is used to control whether to delegate the <strong>instruction acquisition error exception</strong> to S-Mode for processing</li>
<li>medeleg[12] is used to control whether to delegate <strong>instruction page exception</strong> to  S-Modefor processing</li>
<li>medeleg[9] is used to control whether <strong>data page exception</strong> is delegated to  S-Mode for processing</li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="55" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="55" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Control shift for interrupt/exception handling</h4>
<ul>
<li>When an interrupt/exception occurs, CPU control <strong>usually</strong> will not be delegated to a lower-level privileged mode
<ul>
<li>eg. medeleg[15] will delegate store page fault to S-Mode</li>
<li>Exceptions that occur in M-Mode are always handled in M-Mode</li>
<li>Exceptions in S-Mode are always handled in M-Mode, or in S-Mode</li>
<li>Exceptions that occur in the above two modes will not be handled by U-Mode</li>
</ul>
</li>
</ul>
<p><strong>Why?</strong></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="56" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="56" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Questions</h4>
<ul>
<li>How to implement the breakpoint debugging through the breakpoint exception?</li>
<li>How to implement single-stepping tracking?</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="57" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="57" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
<li>RISC-V system mode</li>
<li>RISC-V system programming: user mode programming</li>
<li>RISC-V system programming: M-Mode programming</li>
</ol>
<h3>5. RISC-V system programming: kernel programming</h3>
<ul>
<li>Interrupt/exception mechanism</li>
<li>Interrupt/exception handling</li>
<li>Virtual memory mechanism</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="58" data-marpit-scope-bqu8yVcL="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="58" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>S-Mode interrupt control and status register</h4>
<ul>
<li>stvec(SupervisorTrapVector) saves the address <strong>to jump to when an interrupt/exception occurs</strong></li>
<li>sepc(Supervisor Exception PC) points to the <strong>instruction when an interrupt/exception occurrs</strong></li>
<li>cause(Supervisor Exception Cause) indicates the <strong>types</strong> of the interrupt/exception</li>
<li>sie(Supervisor Interrupt Enable) interrupt <strong>enable</strong> register</li>
<li>sip (Supervisor Interrupt Pending) interrupt <strong>request</strong> register</li>
<li>stval(Supervisor Trap Value) saves  <strong>Additional Information</strong> of the trap</li>
<li>sscratch (Supervisor Scratch) is the <strong>data transfer station</strong> of different modes</li>
<li>sstatus (Supervisor Status) saves global interrupts and other <strong>status</strong></li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="59" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="59" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Sstatus register</h4>
<ul>
<li>The SIE and SPIE bits of sstatus register respectively save the current interrupt enable <strong>status</strong> and status before the interrupt/exception occurs</li>
</ul>
<p><img src="figs/rv-sstatus.png" alt="" style="width:1100px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="60" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="60" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>S-Mode Interrupt/Exception Mechanism</h4>
<p><strong>sie &amp; sip register</strong> is a CSR used to save <strong>pending interrupt</strong> and <strong>interrupt enable</strong></p>
<ul>
<li>sie (supervisor interrupt-enabled register)</li>
<li>sip (supervisor interrupt pending)</li>
</ul>
<p><img src="figs/rv-sie-sip.png" alt="" style="width:1150px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="61" data-marpit-scope-20huI9fi="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="61" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Scause register</h4>
<p>When an exception occurs, an event number indicating <strong>the source of the interrupt/exception</strong> will be written into the CSR, recorded in the <code>Exception Code</code> field; if the event is caused by an interrupt, the <code>Interrupt</code> bit is set.</p>
<p><img src="figs/rv-cause.png" alt="" style="width:1150px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="62" data-marpit-scope-DO2NWrvS="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="62" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Mtvec &amp; stvec registers</h4>
<p>The trap-vector base address register (stvec CSR) is used to configure the <strong>trap_handler address</strong></p>
<ul>
<li>It includes vector base address(BASE) and vector mode (MODE): the value in the BASE field is 4-byte aligned
<ul>
<li>MODE = 0 means one trap_handler handles all interrupts/exceptions</li>
<li>MODE = 1 means each interrupt/exception has a corresponding trap_handler</li>
</ul>
</li>
</ul>
<p>mtvec &amp; stvec registers<br />
<img src="figs/rv-tvec.png" alt="" style="width:1000px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="63" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="63" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
<li>RISC-V system mode</li>
<li>RISC-V system programming: user mode programming</li>
<li>RISC-V system programming: M-Mode programming</li>
<li>RISC-V system programming: kernel programming
<ul>
<li>Interrupt/exception mechanism</li>
<li><strong>Interrupt/Exception Handling</strong></li>
<li>Virtual memory mechanism</li>
</ul>
</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="64" data-marpit-scope-eLOE79tm="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="64" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Hardware response to S-Mode interrupts/exceptions</h4>
<p><strong>Hardware Execution</strong></p>
<p>The hart accepts the interrupt/exception and needs to delegate them to S-Mode, then the hardware will undergo the following state transitions atomically</p>
<ol>
<li><strong>PC of executing instruction when Interrupt/exception occurs</strong> is stored in sepc, and PC is set to stvec</li>
<li>scause sets interrupt/exception <strong>type</strong>, stval is set to error address/exception <strong>related information</strong></li>
<li>Set the SIE bit of sstatus to zero, <strong>mask the interrupt</strong>, previous  <strong>SIE</strong> is saved in the SPIE.</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="65" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="65" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Hardware response to S-Mode interrupts/exceptions</h4>
<ol start="4">
<li><strong>The privilege mode before the exception occurred</strong> is saved in the SPP (previous privilege) field of sstatus, and then set the current privilege mode to S-Mode</li>
<li><strong>Jump</strong> to the address set by stvec CSR</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="66" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="66" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>Software Handling for S-Mode Interrupt/Exception</h4>
<ul>
<li><strong>Initialization</strong>
<ul>
<li>Write interrupt/exception handler (such as trap_handler)</li>
<li>Set trap_handler address to stvec</li>
</ul>
</li>
<li>Software execution
<ol>
<li>The processor jumps to <strong>trap_handler</strong></li>
<li>trap_handler <strong>handles</strong> interrupt/exception/system call, etc.</li>
<li><strong>Return</strong> to the previous instruction and previous privilege to continue execution</li>
</ol>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="67" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="67" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<p><strong>Outline</strong></p>
<ol>
<li>Comparison for Mainstream Processors</li>
<li>RISC-V system mode</li>
<li>RISC-V system programming: user mode programming</li>
<li>RISC-V system programming: M-Mode programming</li>
<li>RISC-V system programming: kernel programming
<ul>
<li>Interrupt/exception mechanism</li>
<li>Interrupt/exception handling</li>
<li><strong>Virtual memory mechanism</strong></li>
</ul>
</li>
</ol>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="68" data-marpit-scope-vOYyrRqY="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="68" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>S-Mode virtual memory system</h4>
<ul>
<li>Virtual addresses divide memory into <strong>fixed-size pages</strong> for <strong>address translation</strong> and <strong>content protection</strong>.</li>
<li>satp (Supervisor Address Translation and Protection)  <strong>controls paging</strong>. satp has three fields:
<ul>
<li>The MODE field can <strong>turn on paging</strong> and select the number of page table levels</li>
<li>ASID (Address Space Identifier) field is optional, it can be used to reduce the overhead of context switching</li>
<li>The PPN field records the physical page number of the <strong>root page table</strong><br />
<img src="figs/satp.png" alt="" style="width:900px;" /></li>
</ul>
</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="69" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;--marpit-advanced-background-split:50%;" data-marpit-advanced-background="background" data-marpit-advanced-background-split="right"><div data-marpit-advanced-background-container="true" data-marpit-advanced-background-direction="horizontal"><figure style="background-image:url(&quot;figs/riscv_pagetable.svg&quot;);background-size:100%;"></figure></div></section></foreignObject><foreignObject width="50%" height="720"><section id="69" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="69" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;--marpit-advanced-background-split:50%;" data-marpit-advanced-background="content" data-marpit-advanced-background-split="right">
<h4>S-Mode Virtual Memory Mechanism</h4>
<ul>
<li>Establish <strong>page table base address</strong> through stap CSR</li>
<li>Create <strong>page tables</strong> for OS and APP</li>
<li>Handle memory access <strong>Exception</strong></li>
</ul>
</section>
</foreignObject><foreignObject width="1280" height="720" data-marpit-advanced-background="pseudo"><section style="" data-marpit-advanced-background="pseudo" data-marpit-pagination="69" data-marpit-pagination-total="72"></section></foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="70" data-marpit-scope-i5IpH8aF="" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="70" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>S-Mode virtual memory address translation</h4>
<p>In S, U-Mode, a virtual address will be translated to a physical address by traversing the page table from the root:</p>
<ul>
<li>satp.PPN gives the <strong>first-level page table base address</strong>, VA [31:22] gives the first-level page number, and the CPU will read page table entries located at (satp.PPN × 4096 + VA[31: 22 ] × 4) .</li>
<li>PTE contains <strong>second-level page table base address</strong>, VA[21:12] gives the second-level page number, and CPU will read leaf node page table entries located at (PTE. PPN × 4096 + VA[21: 12] × 4) .</li>
<li><strong>The PPN field of the leaf node page table entry</strong> and the page offset (the lowest 12 bits of the original virtual address) form the final result: physical address (LeafPTE.PPN×4096+VA[11: 0])</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="71" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="71" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h4>S-Mode virtual memory address translation</h4>
<p><img src="figs/satp2.png" alt="" style="width:650px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="72" data-paginate="true" data-background-color="white" data-theme="gaia" data-marpit-pagination="72" data-marpit-pagination-total="72" style="--paginate:true;--background-color:white;--theme:gaia;background-color:white;background-image:none;">
<h3>Summary</h3>
<ul>
<li>Understand RISC-V privilege and hardware isolation methods</li>
<li>Understand the basic characteristics of RISC-V's M-Mode and S-Mode</li>
<li>Understand how OS accesses and controls the computer in M-Mode and S-Mode</li>
<li>Learn how different softwares switch between M-Mode&lt;–&gt;S-Mode&lt;–&gt;U-Mode</li>
</ul>
</section>
<script>!function(){"use strict";const t="marpitSVGPolyfill:setZoomFactor,",e=Symbol();let r,o;function n(n){const i="object"==typeof n&&n.target||document,a="object"==typeof n?n.zoom:n;window[e]||(Object.defineProperty(window,e,{configurable:!0,value:!0}),window.addEventListener("message",(({data:e,origin:r})=>{if(r===window.origin)try{if(e&&"string"==typeof e&&e.startsWith(t)){const[,t]=e.split(","),r=Number.parseFloat(t);Number.isNaN(r)||(o=r)}}catch(t){console.error(t)}})));let l=!1;Array.from(i.querySelectorAll("svg[data-marpit-svg]"),(t=>{var e,n,i,s;t.style.transform||(t.style.transform="translateZ(0)");const c=a||o||t.currentScale||1;r!==c&&(r=c,l=c);const d=t.getBoundingClientRect(),{length:u}=t.children;for(let r=0;r<u;r+=1){const o=t.children[r],a=o.getScreenCTM();if(a){const t=null!==(n=null===(e=o.x)||void 0===e?void 0:e.baseVal.value)&&void 0!==n?n:0,r=null!==(s=null===(i=o.y)||void 0===i?void 0:i.baseVal.value)&&void 0!==s?s:0,l=o.firstElementChild,{style:u}=l;u.transformOrigin||(u.transformOrigin=`${-t}px ${-r}px`),u.transform=`scale(${c}) matrix(${a.a}, ${a.b}, ${a.c}, ${a.d}, ${a.e-d.left}, ${a.f-d.top}) translateZ(0.0001px)`}}})),!1!==l&&Array.from(i.querySelectorAll("iframe"),(({contentWindow:e})=>{null==e||e.postMessage(`${t}${l}`,"null"===window.origin?"*":window.origin)}))}r=1,o=void 0;const i=(t,e,r)=>{if(t.getAttribute(e)!==r)return t.setAttribute(e,r),!0};function a({once:t=!1,target:e=document}={}){const r="Apple Computer, Inc."===navigator.vendor?[n]:[];let o=!t;const a=()=>{for(const t of r)t({target:e});!function(t=document){Array.from(t.querySelectorAll('svg[data-marp-fitting="svg"]'),(t=>{var e;const r=t.firstChild,o=r.firstChild,{scrollWidth:n,scrollHeight:a}=o;let l,s=1;if(t.hasAttribute("data-marp-fitting-code")&&(l=null===(e=t.parentElement)||void 0===e?void 0:e.parentElement),t.hasAttribute("data-marp-fitting-math")&&(l=t.parentElement),l){const t=getComputedStyle(l),e=Math.ceil(l.clientWidth-parseFloat(t.paddingLeft||"0")-parseFloat(t.paddingRight||"0"));e&&(s=e)}const c=Math.max(n,s),d=Math.max(a,1),u=`0 0 ${c} ${d}`;i(r,"width",`${c}`),i(r,"height",`${d}`),i(t,"preserveAspectRatio",getComputedStyle(t).getPropertyValue("--preserve-aspect-ratio")||"xMinYMin meet"),i(t,"viewBox",u)&&t.classList.toggle("__reflow__")}))}(e),o&&window.requestAnimationFrame(a)};return a(),()=>{o=!1}}const l=Symbol(),s=document.currentScript;((t=document)=>{if("undefined"==typeof window)throw new Error("Marp Core's browser script is valid only in browser context.");if(t[l])return t[l];const e=a({target:t}),r=()=>{e(),delete t[l]};Object.defineProperty(t,l,{configurable:!0,value:r})})(s?s.getRootNode():document)}();
</script></foreignObject></svg></div><div class="bespoke-marp-note" data-index="0" tabindex="0"><p>In RISC-V mannual, privilege is used for &quot;privilege level&quot;</p></div><div class="bespoke-marp-note" data-index="3" tabindex="0"><p>Mainly explain that x86, arm due to compatibility and historical reasons, lead to complex design and implementation, riscv is simple/flexible/extensible, easy to learn and master and used to write OS</p></div><div class="bespoke-marp-note" data-index="22" tabindex="0"><p>## RISC-V system mode: control status register CSR
Mandatory isolation to avoid availability/reliability/security impact on the entire system</p></div><div class="bespoke-marp-note" data-index="24" tabindex="0"><p>## RISC-V 系统模式：控制状态寄存器CSR

- mtvec(MachineTrapVector)保存发生异常时需要跳转到的地址。
- mepc(Machine Exception PC)指向发生异常的指令。
- mcause(Machine Exception Cause)指示发生异常的种类。
- mie(Machine Interrupt Enable)指出处理器目前能处理的中断。
- mip(Machine Interrupt Pending)列出目前正准备处理的中断。
- mtval(Machine Trap Value)保存陷入(trap)附加信息:地址例外中出错的地址、发生非法指令例外的指令本身；对于其他异常，值为0。
- mscratch(Machine Scratch)它暂时存放一个字大小的数据。
- mstatus(Machine Status)保存全局中断以及其他的状态</p><p>---
## RISC-V 系统模式：控制状态寄存器CSR

- mcause(Machine Exception Cause)它指示发生异常的种类。
  - SIE控制S-Mode下全局中断，MIE控制M-Mode下全局中断。
  - SPIE、MPIE记录发生中断之前MIE和SIE的值。
---
## RISC-V 系统模式：控制状态寄存器CSR

- sstatus(supervisor status)保存发生异常时需要跳转到的地址。
- stvec(supervisor trap vector)保存s模式的trap向量基址。stvec总是4字节对齐
- satp(supervisor Address Translation and Protection) S-Mode控制状态寄存器控制了分页系统。
- sscratch (supervisor Scratch Register) 保存指向hart-local supervisor上下文的指针. 在trap处理程序的开头，sscratch与用户寄存器交换，以提供初始工作寄存器。
- sepc(supervisor Exception PC)它指向发生异常的指令。</p></div><div class="bespoke-marp-note" data-index="30" tabindex="0"><p>Zifencei extension https://www.cnblogs.com/mikewolf2002/p/11191254.html</p></div><div class="bespoke-marp-note" data-index="31" tabindex="0"><p>Before executing the fence.i instruction, for the same hardware thread (hart), RISC-V does not guarantee that the data written to the memory instruction area by the store instruction can be fetched by the fetch instruction. After using the fence.i command, for the same hart, you can ensure that the command reads the data that was written to the memory command area recently. However, fence.i will not guarantee that the reading of other riscv hart instructions can also meet the read and write consistency. If you want to make the write instruction memory space meet the consistency requirements for all harts, you need to execute the fence instruction.</p></div><div class="bespoke-marp-note" data-index="34" tabindex="0"><p>#### How hardware handles Interrupt/Exception 
1. The PC of the **exception/interrupt instruction** is saved in sepc, and PC is set to stvec.
2. Set scause according to **interrupt/exception source**, and set stval to error address or other related information.
3. Set sstatus[SIE bit] to zero to **mask interrupts** and **save previous SIE value** into SPIE
4. **Save the privilege mode before the exception occurred** into SPP of sstatus, and then **change the privilege mode** to S. 
5. **Jump** to the address set by stvec CSR 
   - Heap &amp; Stack：Save context；Switch page table.

---
&lt;!--#### How software handles S-Mode Interrupt/Exception 

- **Initialization**
   - Write interrupt/exception handler (such as trap_handler)
   - Set trap_handler address to stvec
- Software execution
   1. The processor jumps to **trap_handler**
   2. trap_handler **handles** interrupt/exception/system call, etc.
   3. **Return** to the previous instruction and previous privilege to continue execution</p></div><div class="bespoke-marp-note" data-index="36" tabindex="0"><p>mtval (Machine Trap Value) saves the additional information of the trap: the address of the error in the address exception, the instruction itself where the exception of the illegal instruction occurred; for other exceptions, the value is 0.</p></div><div class="bespoke-marp-note" data-index="53" tabindex="0"><p>, is a subset of mie and mip. These two registers have the same layout as in M-Mode. In sie and sip, only bits corresponding to interrupts delegated by mideleg can be read and written, and bits corresponding to interrupts not delegated are always 0</p></div><div class="bespoke-marp-note" data-index="70" tabindex="0"><p>---
## RISC-V System Programming: Isolation in S-Mode
- S-Mode is more privileged than U-Mode, but less privileged than M-Mode
- Software running in S-Mode cannot use M-Mode CSR and instructions, and is restricted by PMP
- Support page-based virtual memory</p></div><script>/*!! License: https://unpkg.com/@marp-team/marp-cli@1.7.0/lib/bespoke.js.LICENSE.txt */
!function(){"use strict";const e=document.body,t=(...e)=>history.replaceState(...e),n="presenter",r="next",o=["",n,r],a="data-bespoke-marp-",i=(e,{protocol:t,host:n,pathname:r,hash:o}=location)=>{const a=e.toString();return`${t}//${n}${r}${a?"?":""}${a}${o}`},s=()=>e.dataset.bespokeView,l=e=>new URLSearchParams(location.search).get(e),d=(e,n={})=>{var r;const o={location,setter:t,...n},a=new URLSearchParams(o.location.search);for(const t of Object.keys(e)){const n=e[t];"string"==typeof n?a.set(t,n):a.delete(t)}try{o.setter({...null!==(r=window.history.state)&&void 0!==r?r:{}},"",i(a,o.location))}catch(e){console.error(e)}},c=(()=>{const e="bespoke-marp";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}})(),u=e=>{try{return localStorage.getItem(e)}catch(e){return null}},f=(e,t)=>{try{return localStorage.setItem(e,t),!0}catch(e){return!1}},m=e=>{try{return localStorage.removeItem(e),!0}catch(e){return!1}},g=(e,t)=>{const n="aria-hidden";t?e.setAttribute(n,"true"):e.removeAttribute(n)},p=e=>{e.parent.classList.add("bespoke-marp-parent"),e.slides.forEach((e=>e.classList.add("bespoke-marp-slide"))),e.on("activate",(t=>{const n="bespoke-marp-active",r=t.slide,o=r.classList,a=!o.contains(n);if(e.slides.forEach((e=>{e.classList.remove(n),g(e,!0)})),o.add(n),g(r,!1),a){const e=`${n}-ready`;o.add(e),document.body.clientHeight,o.remove(e)}}))},v=e=>{let t=0,n=0;Object.defineProperty(e,"fragments",{enumerable:!0,value:e.slides.map((e=>[null,...e.querySelectorAll("[data-marpit-fragment]")]))});const r=r=>void 0!==e.fragments[t][n+r],o=(r,o)=>{t=r,n=o,e.fragments.forEach(((e,t)=>{e.forEach(((e,n)=>{if(null==e)return;const i=t<r||t===r&&n<=o;e.setAttribute(`${a}fragment`,(i?"":"in")+"active");const s=`${a}current-fragment`;t===r&&n===o?e.setAttribute(s,"current"):e.removeAttribute(s)}))})),e.fragmentIndex=o;const i={slide:e.slides[r],index:r,fragments:e.fragments[r],fragmentIndex:o};e.fire("fragment",i)};e.on("next",(({fragment:a=!0})=>{if(a){if(r(1))return o(t,n+1),!1;const a=t+1;e.fragments[a]&&o(a,0)}else{const r=e.fragments[t].length;if(n+1<r)return o(t,r-1),!1;const a=e.fragments[t+1];a&&o(t+1,a.length-1)}})),e.on("prev",(({fragment:a=!0})=>{if(r(-1)&&a)return o(t,n-1),!1;const i=t-1;e.fragments[i]&&o(i,e.fragments[i].length-1)})),e.on("slide",(({index:t,fragment:n})=>{let r=0;if(void 0!==n){const o=e.fragments[t];if(o){const{length:e}=o;r=-1===n?e-1:Math.min(Math.max(n,0),e-1)}}o(t,r)})),o(0,0)},h=document,y=()=>!(!h.fullscreenEnabled&&!h.webkitFullscreenEnabled),b=()=>!(!h.fullscreenElement&&!h.webkitFullscreenElement),x=e=>{e.fullscreen=()=>{y()&&(async()=>{return b()?null===(e=h.exitFullscreen||h.webkitExitFullscreen)||void 0===e?void 0:e.call(h):((e=h.body)=>{var t;return null===(t=e.requestFullscreen||e.webkitRequestFullscreen)||void 0===t?void 0:t.call(e)})();var e})()},document.addEventListener("keydown",(t=>{"f"!==t.key&&"F11"!==t.key||t.altKey||t.ctrlKey||t.metaKey||!y()||(e.fullscreen(),t.preventDefault())}))},w="bespoke-marp-inactive",k=(e=2e3)=>({parent:t,fire:n})=>{const r=t.classList,o=e=>n(`marp-${e?"":"in"}active`);let a;const i=()=>{a&&clearTimeout(a),a=setTimeout((()=>{r.add(w),o()}),e),r.contains(w)&&(r.remove(w),o(!0))};for(const e of["mousedown","mousemove","touchend"])document.addEventListener(e,i);setTimeout(i,0)},E=["AUDIO","BUTTON","INPUT","SELECT","TEXTAREA","VIDEO"],L=e=>{e.parent.addEventListener("keydown",(e=>{if(!e.target)return;const t=e.target;(E.includes(t.nodeName)||"true"===t.contentEditable)&&e.stopPropagation()}))},$=e=>{window.addEventListener("load",(()=>{for(const t of e.slides){const e=t.querySelector("[data-marp-fitting]")?"":"hideable";t.setAttribute(`${a}load`,e)}}))},S=({interval:e=250}={})=>t=>{document.addEventListener("keydown",(e=>{if(" "===e.key&&e.shiftKey)t.prev();else if("ArrowLeft"===e.key||"ArrowUp"===e.key||"PageUp"===e.key)t.prev({fragment:!e.shiftKey});else if(" "!==e.key||e.shiftKey)if("ArrowRight"===e.key||"ArrowDown"===e.key||"PageDown"===e.key)t.next({fragment:!e.shiftKey});else if("End"===e.key)t.slide(t.slides.length-1,{fragment:-1});else{if("Home"!==e.key)return;t.slide(0)}else t.next();e.preventDefault()}));let n,r,o=0;t.parent.addEventListener("wheel",(a=>{let i=!1;const s=(e,t)=>{e&&(i=i||((e,t)=>((e,t)=>{const n="X"===t?"Width":"Height";return e[`client${n}`]<e[`scroll${n}`]})(e,t)&&((e,t)=>{const{overflow:n}=e,r=e[`overflow${t}`];return"auto"===n||"scroll"===n||"auto"===r||"scroll"===r})(getComputedStyle(e),t))(e,t)),(null==e?void 0:e.parentElement)&&s(e.parentElement,t)};if(0!==a.deltaX&&s(a.target,"X"),0!==a.deltaY&&s(a.target,"Y"),i)return;a.preventDefault();const l=Math.sqrt(a.deltaX**2+a.deltaY**2);if(void 0!==a.wheelDelta){if(void 0===a.webkitForce&&Math.abs(a.wheelDelta)<40)return;if(a.deltaMode===a.DOM_DELTA_PIXEL&&l<4)return}else if(a.deltaMode===a.DOM_DELTA_PIXEL&&l<12)return;r&&clearTimeout(r),r=setTimeout((()=>{n=0}),e);const d=Date.now()-o<e,c=l<=n;if(n=l,d||c)return;let u;(a.deltaX>0||a.deltaY>0)&&(u="next"),(a.deltaX<0||a.deltaY<0)&&(u="prev"),u&&(t[u](),o=Date.now())}))},P=(e=".bespoke-marp-osc")=>{const t=document.querySelector(e);if(!t)return()=>{};const n=(e,n)=>{t.querySelectorAll(`[${a}osc=${JSON.stringify(e)}]`).forEach(n)};return y()||n("fullscreen",(e=>e.style.display="none")),c||n("presenter",(e=>{e.disabled=!0,e.title="Presenter view is disabled due to restricted localStorage."})),e=>{t.addEventListener("click",(t=>{if(t.target instanceof HTMLElement){const{bespokeMarpOsc:n}=t.target.dataset;n&&t.target.blur();const r={fragment:!t.shiftKey};"next"===n?e.next(r):"prev"===n?e.prev(r):"fullscreen"===n?null==e||e.fullscreen():"presenter"===n&&e.openPresenterView()}})),e.parent.appendChild(t),e.on("activate",(({index:t})=>{n("page",(n=>n.textContent=`Page ${t+1} of ${e.slides.length}`))})),e.on("fragment",(({index:t,fragments:r,fragmentIndex:o})=>{n("prev",(e=>e.disabled=0===t&&0===o)),n("next",(n=>n.disabled=t===e.slides.length-1&&o===r.length-1))})),e.on("marp-active",(()=>g(t,!1))),e.on("marp-inactive",(()=>g(t,!0))),y()&&(e=>{for(const t of["","webkit"])h.addEventListener(t+"fullscreenchange",e)})((()=>n("fullscreen",(e=>e.classList.toggle("exit",y()&&b())))))}},T=e=>{window.addEventListener("message",(t=>{if(t.origin!==window.origin)return;const[n,r]=t.data.split(":");if("navigate"===n){const[t,n]=r.split(",");let o=Number.parseInt(t,10),a=Number.parseInt(n,10)+1;a>=e.fragments[o].length&&(o+=1,a=0),e.slide(o,{fragment:a})}}))};var I=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];let N=e=>String(e).replace(/[&<>"']/g,(e=>`&${C[e]};`)),C={"&":"amp","<":"lt",">":"gt",'"':"quot","'":"apos"},A="dangerouslySetInnerHTML",D={className:"class",htmlFor:"for"},M={};function B(e,t){let n=[],r="";t=t||{};for(let e=arguments.length;e-- >2;)n.push(arguments[e]);if("function"==typeof e)return t.children=n.reverse(),e(t);if(e){if(r+="<"+e,t)for(let e in t)!1!==t[e]&&null!=t[e]&&e!==A&&(r+=` ${D[e]?D[e]:N(e)}="${N(t[e])}"`);r+=">"}if(-1===I.indexOf(e)){if(t[A])r+=t[A].__html;else for(;n.length;){let e=n.pop();if(e)if(e.pop)for(let t=e.length;t--;)n.push(e[t]);else r+=!0===M[e]?e:N(e)}r+=e?`</${e}>`:""}return M[r]=!0,r}const K=({children:e})=>B(null,null,...e),O="bespoke-marp-presenter-",q={container:`${O}container`,dragbar:`${O}dragbar-container`,next:`${O}next`,nextContainer:`${O}next-container`,noteContainer:`${O}note-container`,noteWrapper:`${O}note-wrapper`,noteButtons:`${O}note-buttons`,infoContainer:`${O}info-container`,infoPage:`${O}info-page`,infoPageText:`${O}info-page-text`,infoPagePrev:`${O}info-page-prev`,infoPageNext:`${O}info-page-next`,noteButtonsBigger:`${O}note-bigger`,noteButtonsSmaller:`${O}note-smaller`,infoTime:`${O}info-time`,infoTimer:`${O}info-timer`},_=e=>{const{title:t}=document;document.title="[Presenter view]"+(t?` - ${t}`:"");const n={},r=e=>(n[e]=n[e]||document.querySelector(`.${e}`),n[e]);document.body.appendChild((e=>{const t=document.createElement("div");return t.className=q.container,t.appendChild(e),t.insertAdjacentHTML("beforeend",B(K,null,B("div",{class:q.nextContainer},B("iframe",{class:q.next,src:"?view=next"})),B("div",{class:q.dragbar}),B("div",{class:q.noteContainer},B("div",{class:q.noteWrapper}),B("div",{class:q.noteButtons},B("button",{class:q.noteButtonsSmaller,tabindex:"-1",title:"Smaller notes font size"},"Smaller notes font size"),B("button",{class:q.noteButtonsBigger,tabindex:"-1",title:"Bigger notes font size"},"Bigger notes font size"))),B("div",{class:q.infoContainer},B("div",{class:q.infoPage},B("button",{class:q.infoPagePrev,tabindex:"-1",title:"Previous"},"Previous"),B("span",{class:q.infoPageText}),B("button",{class:q.infoPageNext,tabindex:"-1",title:"Next"},"Next")),B("time",{class:q.infoTime,title:"Current time"}),B("time",{class:q.infoTimer,title:"Timer"})))),t})(e.parent)),(e=>{let t=!1;r(q.dragbar).addEventListener("mousedown",(()=>{t=!0,r(q.dragbar).classList.add("active")})),window.addEventListener("mouseup",(()=>{t=!1,r(q.dragbar).classList.remove("active")})),window.addEventListener("mousemove",(e=>{if(!t)return;const n=e.clientX/document.documentElement.clientWidth*100;r(q.container).style.setProperty("--bespoke-marp-presenter-split-ratio",`${Math.max(0,Math.min(100,n))}%`)})),r(q.nextContainer).addEventListener("click",(()=>e.next()));const n=r(q.next),o=(a=n,(e,t)=>{var n;return null===(n=a.contentWindow)||void 0===n?void 0:n.postMessage(`navigate:${e},${t}`,"null"===window.origin?"*":window.origin)});var a;n.addEventListener("load",(()=>{r(q.nextContainer).classList.add("active"),o(e.slide(),e.fragmentIndex),e.on("fragment",(({index:e,fragmentIndex:t})=>o(e,t)))}));const i=document.querySelectorAll(".bespoke-marp-note");i.forEach((e=>{e.addEventListener("keydown",(e=>e.stopPropagation())),r(q.noteWrapper).appendChild(e)})),e.on("activate",(()=>i.forEach((t=>t.classList.toggle("active",t.dataset.index==e.slide())))));let s=0;const l=e=>{s=Math.max(-5,s+e),r(q.noteContainer).style.setProperty("--bespoke-marp-note-font-scale",(1.2**s).toFixed(4))},d=()=>l(1),c=()=>l(-1),u=r(q.noteButtonsBigger),f=r(q.noteButtonsSmaller);u.addEventListener("click",(()=>{u.blur(),d()})),f.addEventListener("click",(()=>{f.blur(),c()})),document.addEventListener("keydown",(e=>{"+"===e.key&&d(),"-"===e.key&&c()}),!0),e.on("activate",(({index:t})=>{r(q.infoPageText).textContent=`${t+1} / ${e.slides.length}`}));const m=r(q.infoPagePrev),g=r(q.infoPageNext);m.addEventListener("click",(t=>{m.blur(),e.prev({fragment:!t.shiftKey})})),g.addEventListener("click",(t=>{g.blur(),e.next({fragment:!t.shiftKey})})),e.on("fragment",(({index:t,fragments:n,fragmentIndex:r})=>{m.disabled=0===t&&0===r,g.disabled=t===e.slides.length-1&&r===n.length-1}));let p=new Date;const v=()=>{const e=new Date,t=e=>`${Math.floor(e)}`.padStart(2,"0"),n=e.getTime()-p.getTime(),o=t(n/1e3%60),a=t(n/1e3/60%60),i=t(n/36e5%24);r(q.infoTime).textContent=e.toLocaleTimeString(),r(q.infoTimer).textContent=`${i}:${a}:${o}`};v(),setInterval(v,250),r(q.infoTimer).addEventListener("click",(()=>{p=new Date}))})(e)},X=e=>{if(!(e=>e.syncKey&&"string"==typeof e.syncKey)(e))throw new Error("The current instance of Bespoke.js is invalid for Marp bespoke presenter plugin.");Object.defineProperties(e,{openPresenterView:{enumerable:!0,value:F},presenterUrl:{enumerable:!0,get:U}}),c&&document.addEventListener("keydown",(t=>{"p"!==t.key||t.altKey||t.ctrlKey||t.metaKey||(t.preventDefault(),e.openPresenterView())}))};function F(){const{max:e,floor:t}=Math,n=e(t(.85*window.innerWidth),640),r=e(t(.85*window.innerHeight),360);return window.open(this.presenterUrl,O+this.syncKey,`width=${n},height=${r},menubar=no,toolbar=no`)}function U(){const e=new URLSearchParams(location.search);return e.set("view","presenter"),e.set("sync",this.syncKey),i(e)}const V=e=>{const t=s();return t===r&&e.appendChild(document.createElement("span")),{"":X,[n]:_,[r]:T}[t]},R=e=>{e.on("activate",(t=>{document.querySelectorAll(".bespoke-progress-parent > .bespoke-progress-bar").forEach((n=>{n.style.flexBasis=100*t.index/(e.slides.length-1)+"%"}))}))},j=e=>{const t=Number.parseInt(e,10);return Number.isNaN(t)?null:t},H=(e={})=>{const t={history:!0,...e};return e=>{let n=!0;const r=e=>{const t=n;try{return n=!0,e()}finally{n=t}},o=(t={fragment:!0})=>{((t,n)=>{const{min:r,max:o}=Math,{fragments:a,slides:i}=e,s=o(0,r(t,i.length-1)),l=o(0,r(n||0,a[s].length-1));s===e.slide()&&l===e.fragmentIndex||e.slide(s,{fragment:l})})((j(location.hash.slice(1))||1)-1,t.fragment?j(l("f")||""):null)};e.on("fragment",(({index:e,fragmentIndex:r})=>{n||d({f:0===r||r.toString()},{location:{...location,hash:`#${e+1}`},setter:(...e)=>t.history?history.pushState(...e):history.replaceState(...e)})})),setTimeout((()=>{o(),window.addEventListener("hashchange",(()=>r((()=>{o({fragment:!1}),d({f:void 0})})))),window.addEventListener("popstate",(()=>{n||r((()=>o()))})),n=!1}),0)}},W=(e={})=>{var n;const r=e.key||(null===(n=window.history.state)||void 0===n?void 0:n.marpBespokeSyncKey)||Math.random().toString(36).slice(2),o=`bespoke-marp-sync-${r}`;var a;a={marpBespokeSyncKey:r},d({},{setter:(e,...n)=>t({...e,...a},...n)});const i=()=>{const e=u(o);return e?JSON.parse(e):Object.create(null)},s=e=>{const t=i(),n={...t,...e(t)};return f(o,JSON.stringify(n)),n},l=()=>{window.removeEventListener("pageshow",l),s((e=>({reference:(e.reference||0)+1})))};return e=>{l(),Object.defineProperty(e,"syncKey",{value:r,enumerable:!0});let t=!0;setTimeout((()=>{e.on("fragment",(e=>{t&&s((()=>({index:e.index,fragmentIndex:e.fragmentIndex})))}))}),0),window.addEventListener("storage",(n=>{if(n.key===o&&n.oldValue&&n.newValue){const r=JSON.parse(n.oldValue),o=JSON.parse(n.newValue);if(r.index!==o.index||r.fragmentIndex!==o.fragmentIndex)try{t=!1,e.slide(o.index,{fragment:o.fragmentIndex})}finally{t=!0}}}));const n=()=>{const{reference:e}=i();void 0===e||e<=1?m(o):s((()=>({reference:e-1})))};window.addEventListener("pagehide",(e=>{e.persisted&&window.addEventListener("pageshow",l),n()})),e.on("destroy",n)}},{PI:Y,abs:J,sqrt:z,atan2:G}=Math,Q={passive:!0},Z=({slope:e=-.7,swipeThreshold:t=30}={})=>n=>{let r;const o=n.parent,a=e=>{const t=o.getBoundingClientRect();return{x:e.pageX-(t.left+t.right)/2,y:e.pageY-(t.top+t.bottom)/2}};o.addEventListener("touchstart",(({touches:e})=>{r=1===e.length?a(e[0]):void 0}),Q),o.addEventListener("touchmove",(e=>{if(r)if(1===e.touches.length){e.preventDefault();const t=a(e.touches[0]),n=t.x-r.x,o=t.y-r.y;r.delta=z(J(n)**2+J(o)**2),r.radian=G(n,o)}else r=void 0})),o.addEventListener("touchend",(o=>{if(r){if(r.delta&&r.delta>=t&&r.radian){const t=(r.radian-e+Y)%(2*Y)-Y;n[t<0?"next":"prev"](),o.stopPropagation()}r=void 0}}),Q)},ee="_tA",te=e=>{const t=document.documentTransition;if(!t)return;let n;e._tP=!1;const r=(n,{back:r,cond:o})=>a=>{var i,s;const l=e.slides[e.slide()].querySelector("section[data-transition]");if(!l)return!0;const d=document.querySelector(".bespoke-marp-osc"),c=d?[d]:void 0;if(e._tP){if(a._tA){e._tP=!1;try{t.start({sharedElements:c}).catch((()=>{}))}catch(e){}return!0}}else{if(!o(a))return!0;const d="transition"+(a.back||r?"Back":""),u=Number.parseInt(null!==(i=l.dataset[`${d}Duration`])&&void 0!==i?i:"",10),f=Number.parseInt(null!==(s=l.dataset[`${d}Delay`])&&void 0!==s?s:"",10),m={};Number.isNaN(u)||(m.duration=u.toString()),Number.isNaN(f)||(m.delay=f.toString()),e._tP=t.prepare({rootTransition:l.dataset[d],rootConfig:m,sharedElements:c}).then((()=>n(a))).catch((()=>n(a)))}return!1};e.on("prev",r((t=>e.prev({...t,[ee]:!0})),{back:!0,cond:e=>{var t;return e.index>0&&!((null===(t=e.fragment)||void 0===t||t)&&n.fragmentIndex>0)}})),e.on("next",r((t=>e.next({...t,[ee]:!0})),{cond:t=>t.index+1<e.slides.length&&!(n.fragmentIndex+1<n.fragments.length)})),setTimeout((()=>{e.on("slide",r((t=>e.slide(t.index,{...t,[ee]:!0})),{cond:t=>{const n=e.slide();return t.index!==n&&(t.back=t.index<n,!0)}}))}),0),e.on("fragment",(e=>{n=e}))};let ne;const re=()=>(void 0===ne&&(ne="wakeLock"in navigator&&navigator.wakeLock),ne),oe=async()=>{const e=re();if(e)try{return await e.request("screen")}catch(e){console.warn(e)}return null},ae=async()=>{if(!re())return;let e;const t=()=>{e&&"visible"===document.visibilityState&&oe()};for(const e of["visibilitychange","fullscreenchange"])document.addEventListener(e,t);return e=await oe(),e};((t=document.getElementById("p"))=>{(()=>{const t=l("view");e.dataset.bespokeView=t===r||t===n?t:""})();const a=(e=>{const t=l(e);return d({[e]:void 0}),t})("sync")||void 0;var i,c,u,f,m,g,h,y,b,w,E,T;i=t,c=((...e)=>{const t=o.findIndex((e=>s()===e));return e.map((([e,n])=>e[t]&&n)).filter((e=>e))})([[1,1,0],W({key:a})],[[1,1,1],V(t)],[[1,1,0],L],[[1,1,1],p],[[1,0,0],k()],[[1,1,1],$],[[1,1,1],H({history:!1})],[[1,1,0],S()],[[1,1,0],x],[[1,0,0],R],[[1,1,0],Z()],[[1,0,0],P()],[[1,0,0],te],[[1,1,1],v],[[1,1,0],ae]),f=1===(i.parent||i).nodeType?i.parent||i:document.querySelector(i.parent||i),m=[].filter.call("string"==typeof i.slides?f.querySelectorAll(i.slides):i.slides||f.children,(function(e){return"SCRIPT"!==e.nodeName})),g={},h=function(e,t){return(t=t||{}).index=m.indexOf(e),t.slide=e,t},w=function(e,t){m[e]&&(u&&b("deactivate",h(u,t)),u=m[e],b("activate",h(u,t)))},E=function(e,t){var n=m.indexOf(u)+e;b(e>0?"next":"prev",h(u,t))&&w(n,t)},T={off:y=function(e,t){g[e]=(g[e]||[]).filter((function(e){return e!==t}))},on:function(e,t){return(g[e]||(g[e]=[])).push(t),y.bind(null,e,t)},fire:b=function(e,t){return(g[e]||[]).reduce((function(e,n){return e&&!1!==n(t)}),!0)},slide:function(e,t){if(!arguments.length)return m.indexOf(u);b("slide",h(m[e],t))&&w(e,t)},next:E.bind(null,1),prev:E.bind(null,-1),parent:f,slides:m,destroy:function(e){b("destroy",h(u,e)),g={}}},(c||[]).forEach((function(e){e(T)})),u||w(0)})()}();</script></body></html>